# Using PUMAS to subsample GWAS data

# I cloned the repository with
git clone https://github.com/qlu-lab/PUMAS.git

#Download the approximately independent LD blocks
wget ftp://ftp.biostat.wisc.edu/pub/lu_group/Projects/PUMAS/LD/ld_1kg.RData
wget ftp://ftp.biostat.wisc.edu/pub/lu_group/Projects/PUMAS/LD/rs_1kg.RData

#Download the genotype data from the LD panel
wget ftp://ftp.biostat.wisc.edu/pub/lu_group/Projects/PUMAS/LD/1kg_hm3_QCed_noM*

#Install R dependencies
library(optparse)
library(data.table)
library(BEDMatrix)
library(parallel)

#Subsample creation
#First, need to make sure the GWAS file has at least following columns:
SNP: SNP identifier (rsID)
A1: effective allele
A2: other allele
MAF: minor allele frequency
BETA: SNP effect size estimation
SE: standard error for BETA
P: P-value
N: sample size

#Unzip gwas file if needed
zcat ./gwas/hg38_PUKBB_AFR_chronotype.tsv.gz |awk '{print "chr" $1 "_" $2 "_" $3 "_" $4 "_b38\t" $0}' > ./gwas/hg38_PUKBB_AFR_chronotype.tsv 
#gzip ./gwas/hg38_PUKBB_AFR_chronotype.tsv

# Running QC on GWAS data with PUMAS code
Rscript ./code/gwas_qc.R \--file_path ./gwas/hg38_PUKBB_AFR_chronotype.tsv \--frq_path ./1kg_hm3_QCed_noM_freq.frq \--output_path ./ \--snp panel_variant_id \--a1 effect_allele \--a2 non_effect_allele \--stat effect_size \--p pvalue \--n.total 1180 \--chr chromosome \--bp position \--se standard_error \--maf frequency    

#join bim and gwas files
library(data.table)
library(dplyr)
"%&%" = function(a,b) paste(a,b,sep="")
#creating ID columns in bim and gwas
bim <- fread("/home/grace/PUMAS/1kg_hm3_QCed_noM.bim") 
bim <- mutate(bim, ID = (V1 %&% "_" %&% V4))

gwas <- fread("./gwas/hg38_PUKBB_AFR_chronotype.tsv")
gwas <- mutate(gwas, ID = (chr %&% "_" %&% pos))

#joining the files
joined <- inner_join(gwas,bim, by = c("ID"="ID"))
joined <- select(joined, c("pos", "ref", "alt", "beta_afr", "se_meta", "pval_afr", "chr", "af_afr", "V2"))

#writing new gwas file
fwrite(joined, "/home/grace/PUMAS/AFR_chron_gwas")
data <- fread("/home/grace/PUMAS/AFR_chron_gwas")

#Next run subsample script for PUMAS
Rscript ./code/PUMAS_subsampling.R \--k 4 \--partitions 0.75,0.25 \--trait_name AFR_chron_gwas \--gwas_path ./gwas/ \--ld_path ./LD \--output_path ./output/

#Run subsample script for PUMAS-CUBS
Rscript ./code/PUMA-CUBS.subsampling.R \--k 4 \--partitions 0.6,0.2,0.1,0.1 \--trait_name AFR_chron_gwas \--gwas_path ./gwas/ \--ld_path ./LD/ \--output_path ./output/
